<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å¯¾è©±ç·´ç¿’ï¼ˆGPTï¼‰</title>
  <meta name="description" content="åƒéŸ³ç—‡ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®ã‚µã‚¤ãƒˆ">
  <meta name="viewport" content="width=device-width">
  <link href="./css/common.css" rel="stylesheet">
  <link href="./css/conversation.css" rel="stylesheet">
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <a class="header-logo" href="./index.html">
        <img src="./images/namakemono.png" alt="namakemono">
      </a>
      <div class="header-site-menu">
        <nav class="site-menu">
          <ul>
            <li><a href="./read_practice.html">éŸ³èª­ç·´ç¿’</a></li>
            <li><a href="./weak_point_practice.html">è‹¦æ‰‹ç·´ç¿’</a></li>
            <li><a href="./understand.html">åŸå› ã‚’ç†è§£ã™ã‚‹</a></li>
            <li><a href="./conversation_practice.html">çŠ¶æ³åˆ¥ã®ç·´ç¿’ã‚’ã™ã‚‹</a></li>
          </ul>
        </nav>
      </div>
    </div>
  </header>

  <div class="chat-container">
    <h2>GPTã¨ã®å¯¾è©±ç·´ç¿’</h2>
    <div id="chat-log"></div>
    <input type="text" id="userInput" placeholder="å…¥åŠ›ã—ã¦ãã ã•ã„">
    <button onclick="sendMessage()">é€ä¿¡</button>
    <button onclick="startVoiceInput()">ğŸ¤ éŸ³å£°å…¥åŠ›</button>
  </div>

  <script>
    async function sendMessage() {
      const input = document.getElementById("userInput");
      const message = input.value.trim();
      if (!message) return;

      appendMessage("ã‚ãªãŸ", message);
      input.value = "";

      try {
        const response = await fetch("http://localhost:3000/api/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error("APIã‚¨ãƒ©ãƒ¼: " + errorText);
        }

        const data = await response.json();
        const reply = data.reply || "è¿”ç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        appendMessage("GPT", reply);
        speak(reply);
      } catch (error) {
        appendMessage("ã‚¨ãƒ©ãƒ¼", error.message);
      }
    }

    function appendMessage(sender, message) {
      const chat = document.getElementById("chat-log");
      const msg = document.createElement("div");
      msg.innerHTML = `<strong>${sender}:</strong> ${message}`;
      chat.appendChild(msg);
      chat.scrollTop = chat.scrollHeight;
    }

    function startVoiceInput() {
      if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚Chromeã‚’ä½¿ã£ã¦ãã ã•ã„ã€‚");
        return;
      }

      const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "ja-JP";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = function (event) {
        const transcript = event.results[0][0].transcript;
        document.getElementById("userInput").value = transcript;
        sendMessage();
      };

      recognition.onerror = function (event) {
        appendMessage("ã‚¨ãƒ©ãƒ¼", "éŸ³å£°èªè­˜ã‚¨ãƒ©ãƒ¼: " + event.error);
      };
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = "ja-JP";
      utterance.pitch = 1.0;
      utterance.rate = 1.3;
      speechSynthesis.speak(utterance);
    }
  </script>
</body>
</html>
